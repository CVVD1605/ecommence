{% extends 'base.html' %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>üõí Shopping Cart</h1>

    {% if cart_items %}
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>{{ item.product.description }}</td>
                    <td>{{ item.qty }}</td>
                    <td>${{ item.price }}</td>
                    <td>${{ item.line_total }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Total: ${{ cart.total }}</h3>

        <form method="post" action="{% url 'checkout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Complete Purchase</button>
        </form>
    {% else %}
        <p class="alert alert-warning">‚ö†Ô∏è Your cart is empty.</p>
    {% endif %}

    <!-- ‚úÖ AI-Powered Recommended Products Section -->
    {% if recommended_products %}
    <h3>‚ú® Recommended for You</h3>
    <div class="row">
        {% for product in recommended_products %}
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ product.code }}</h5>  <!-- ‚úÖ Fix: Use 'code' instead of 'name' -->
                        <p class="card-text">{{ product.description }}</p>
                        <p><strong>Price:</strong> ${{ product.price }}</p>
                        <button class="btn btn-primary" onclick="addToCart('{{ product.id }}')">Add to Cart</button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

</div>

<script>
    function addToCart(productId) {
        fetch(`/cart/add/${productId}/`, {  
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ product_id: productId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Product added to cart!');
                location.reload();
            } else if (data.error) {
                alert('‚ö†Ô∏è ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            alert('‚ùå An error occurred. Please try again.');
        });
    }
</script>

{% endblock %}
